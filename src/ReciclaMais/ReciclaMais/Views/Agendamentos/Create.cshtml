@model ReciclaMais.Models.Agendamento

@{
    ViewData["Title"] = "Criar Agendamento";
    var produtos = ViewBag.Produtos as List<ReciclaMais.Models.Produto>;
    var estadosConservacao = Enum.GetValues(typeof(ReciclaMais.Enuns.EstadosConservacao));
}

<h2>Agende a sua coleta!</h2>

<form asp-action="Create" method="post">
    <!-- Linha para Data e Horário -->
    <div class="row">
        <div class="col-md-3">
            <div class="form-group">
                <label asp-for="DataAgendamento"></label>
                <input asp-for="DataAgendamento" type="date" class="form-control" oninput="validarDiasPermitidos(this)" />
                <span asp-validation-for="DataAgendamento" class="text-danger"></span>
            </div>
        </div>

        <div class="col-md-2">
            <div class="form-group">
                <label asp-for="Horario">Horário</label>
                <select asp-for="Horario" class="form-control">
                    @if (ViewBag.HorariosDisponiveis != null)
                    {
                        foreach (var horario in ViewBag.HorariosDisponiveis)
                        {
                            <option value="@horario">@horario</option>
                        }
                    }
                    else
                    {
                        <option value="">Nenhum horário disponível</option>
                    }
                </select>
                <span asp-validation-for="Horario" class="text-danger"></span>
            </div>
        </div>
    </div>
    <br />
    <h3>Itens de Coleta</h3>
    <div id="itensColetaContainer">
        <!-- Item de Coleta Base -->
        <div class="itemColeta">
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Produto</label>
                        <select name="ItensColeta[0].ProdutoId" class="form-control produtoSelect" onchange="atualizarPontuacao(this)">
                            @foreach (var produto in produtos)
                            {
                                <option value="@produto.Id" data-pontuacao="@produto.PontuacaoUnitaria">@produto.Nome</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label>Quantidade</label>
                        <input type="number" name="ItensColeta[0].Quantidade" class="form-control quantidadeInput" value="1" min="1" onchange="atualizarPontuacao(this)" />
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Estado de Conservação</label>
                        <select name="ItensColeta[0].EstadoConservacao" class="form-control estadoSelect" onchange="atualizarPontuacao(this)">
                            @foreach (var estado in ViewBag.EstadosConservacao as List<EstadoConservacaoViewModel>)
                            {
                                <option value="@estado.Nome" data-percentual="@estado.Percentual">@estado.Nome</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        @* <button type="button" class="btn btn-danger removeItemBtn" onclick="removerItem(this)">Remover</button> *@
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <label>Pontuação</label>
                    <span class="pontuacaoItem">0</span>
                </div>
            </div>
        </div>
    </div>

    <button type="button" id="addItemBtn" class="btn btn-primary">Adicionar Item</button>

    <br />
    <br />
    <h4>Pontuação Total: <span id="pontuacaoTotal">0</span></h4>

    <div>
        <button type="submit" class="btn btn-success">Salvar</button>
    </div>
</form>

@section Scripts {
    <script>
        let itemIndex = 0;

        // Adicionar um novo item de coleta
        document.getElementById("addItemBtn").addEventListener("click", function () {
            itemIndex++;
            const container = document.getElementById("itensColetaContainer");

            const newItemHtml = `
                <div class="itemColeta">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <select name="ItensColeta[${itemIndex}].ProdutoId" class="form-control produtoSelect" onchange="atualizarPontuacao(this)">
        @foreach (var produto in produtos)
        {
                                            <option value="@produto.Id" data-pontuacao="@produto.PontuacaoUnitaria">@produto.Nome</option>
        }
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <input type="number" name="ItensColeta[${itemIndex}].Quantidade" class="form-control quantidadeInput" value="1" min="1" onchange="atualizarPontuacao(this)" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <select name="ItensColeta[${itemIndex}].EstadoConservacao" class="form-control estadoSelect" onchange="atualizarPontuacao(this)">
        @foreach (var estado in estadosConservacao)
        {
                                            <option value="@estado">@estado</option>
        }
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <button type="button" class="btn btn-danger removeItemBtn" onclick="removerItem(this)">X</button>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <span class="pontuacaoItem">0</span>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML("beforeend", newItemHtml);
        });

        // Atualizar pontuação de cada item e total
        function atualizarPontuacao(element) {
            const itemColeta = element.closest('.itemColeta');
            const produtoSelect = itemColeta.querySelector('.produtoSelect');
            const quantidadeInput = itemColeta.querySelector('.quantidadeInput');
            const estadoSelect = itemColeta.querySelector('.estadoSelect');
            const pontuacaoItem = itemColeta.querySelector('.pontuacaoItem');

            // Obter pontuação base do produto
            const pontuacaoBase = parseInt(produtoSelect.selectedOptions[0].getAttribute('data-pontuacao')) || 0;
            const quantidade = parseInt(quantidadeInput.value) || 0;

            // Obter multiplicador do estado de conservação
            const percentual = parseFloat(estadoSelect.selectedOptions[0].getAttribute('data-percentual')) || 1;

            // Calcular pontuação do item
            const pontuacaoTotalItem = Math.round(pontuacaoBase * quantidade * percentual);
            pontuacaoItem.textContent = pontuacaoTotalItem;

            // Atualizar pontuação total
            atualizarPontuacaoTotal();
        }

        // Função para atualizar a pontuação total (caso queira somar todas as pontuações)
        function atualizarPontuacaoTotal() {
            const pontuacaoItems = document.querySelectorAll('.pontuacaoItem');
            let total = 0;
            pontuacaoItems.forEach(item => {
                total += parseInt(item.textContent) || 0;
            });
            document.getElementById("pontuacaoTotal").textContent = total;
        }

        // Remover item de coleta
        function removerItem(button) {
            const itemColeta = button.closest('.itemColeta');
            itemColeta.remove(); // Remove o item da lista
            atualizarPontuacaoTotal(); // Atualiza a pontuação total
        }

        function validarDiasPermitidos(input) {
            const dataSelecionada = new Date(input.value);
            const diaSemana = dataSelecionada.getDay();

            // Verifica se o dia não é terças-feira (1) nem quintas-feira (3)
            if (diaSemana !== 1 && diaSemana !== 3) {
                input.value = ""; // Limpa o campo de data
                alert("Apenas as terças-feiras e quintas-feiras são permitidas.");
            }
        }
    </script>
}
